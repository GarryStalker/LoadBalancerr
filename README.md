# gRPC Load Balancer

## Сервис-балансировщик видео-трафика

### Задача:

Нужно написать максимально простой сервис-балансировщик пользовательских вызовов, который должен отправлять пользователя с помощью редиректа смотреть фильм либо на корневые сервера, либо отправлять его в CDN по определённым правилам.
При этом сервис должен без проблем обрабатывать не менее 10000 вызовов в секунду
на среднем ноутбуке с core i5 7го поколения и 16GB RAM.

### Требования к стеку технологий

golang 1.17 (или выше)

### Входные данные

Ожидается, что сервис будет обрабатывать вызовы вида:

```
grpcurl -d '{"video": "http://s1.origin-cluster/video/123/xcg2djHckad.m3u8"}' \`
`balancer-domain:443 my.custom.server.Service/Method
```

Где:
1. balancer-domain - хостнейм сервиса балансировки,
2. http://s1.origin-cluster/video/123/xcg2djHckad.m3u8 - URL видео-файла на
сервере оригиналов s1, который нужно отдать пользователю либо через CDN,
либо напрямую с севера оригиналов.

Алгоритм обработки вызовов 
1. Каждый 10й вызов, формата описанного выше, отправляем в оригинальный урл
2. Остальные отправляем на http://$CDN_HOST/s1/video/123/xcg2djHckad.m3u8,
где:
+ s1 - сервер в кластере оригиналов
+ $CDN_HOST - настраиваемый через env url сервиса CDN.
## [PROTOs](https://github.com/GarryStalker/loadBalancer_protos)
## Тесты

Для нагрузочного тестирования использовался инструмент [gHz](https://github.com/bojand/ghz):
```
ghz --insecure \                                                                 
    --proto loadbalancer.proto \
    --call loadBalancer.loadBalancer.Redirect \
    -d '{"video": "http://s1.origin-cluster/video/123/xcg2djHckad.m3u8"}' \
    --rps 15000 \
    --duration 60s \
    localhost:443
```
Результаты при минутном тестировании: 
![load_test](https://github.com/GarryStalker/LoadBalancerr/blob/main/pics/loadTest.jpg?raw=true)
## Нюансы и что можно было бы улучшить

1. config.go мог бы возвращать ошибку, которую мы могли бы в main обрабатывать. Но так как конфиг всегда должен быть загружен в приложение, иначе оно не запустится, было принято решение, что паниковать в данном случае приемлемо;

2. Можно добавить метрики в приложение, пример: кол-во редиректов, кол-во ошибок в сервисе, RPS, возвращаемые статус коды. Аналогично загрузка CPU, heap memory allocated, RAM in USE, кол-во запущенных горутин и многие другие метрики, которые мы хотим видеть в реальном приложении, чтобы вовремя замечать деградацию сервиса и его утечки;

3. Все эти метрики из пункта 2 могли подтягиваться Prometheus, затем по метрикам мы могли бы построить Grafana-графики, чтобы отслеживать стабильность/жизнеспособность сервиса наглядно;

4. Также мы могли бы добавить трейсинг opentelemetry: в данном сервисе как и все остальное это будет выглядеть избыточным, но на реальном проде без этого не обойтись;

5. Можно подметить, что алгоритм балансировки немного необычный, все-таки в продакшене мы бы использовали либо round robbin, Weighted Round Robin, Least Connections ну или Destination Hash Scheduling;
   
6. Нужно покрыть код приложения тестами, включая юнит-тесты для проверки логики метода Redirect. Также необходимо добавить интеграционные тесты для проверки корректной работы сервиса через gRPC-интерфейс.

7. Как вариант, логгер можно было бы прокидывать в контексте, используя `loggerCtxKey struct{}`, было бы возможно даже элегантнее, но оставил как есть по итогу;

8. Логги у нас сейчас пишутся в stdout, stderr, но по-хорошему (если продакшен сервис), они должны собираться и агрегироваться (для этого обычно используется ELK стэк), чтобы в последствии мы могли на них посмотреть через какую-нибудь веб морду.

## Запуск
Что бы запустить- склонируйте проект в удобную директорию, далее используйте команду: 
```
docker compose up
```

Что бы протестировать, используйте инструмент [gHz](https://github.com/bojand/ghz).
Пример команды:
```
ghz --insecure \                                                                 
    --proto loadbalancer.proto \
    --call loadBalancer.loadBalancer.Redirect \
    -d '{"video": "http://s1.origin-cluster/video/123/xcg2djHckad.m3u8"}' \
    --rps 15000 \
    --duration 60s \
    localhost:443
```
Скрин работы программы: 
![in_progress](https://github.com/GarryStalker/LoadBalancerr/blob/main/pics/inProgress.jpg?raw=true)

